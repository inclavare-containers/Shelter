#!/bin/sh

BUSYBOX="/usr/bin/busybox"
[ ! -x "$BUSYBOX" ] && BUSYBOX="/usr/sbin/busybox"

$BUSYBOX --install -s /usr/bin/

mount -t tmpfs tmpfs /dev
mount -t proc proc /proc
mount -t sysfs sysfs /sys
mkdir /dev/pts
mount -t devpts devpts /dev/pts

if [ -e /proc/sys/kernel/hotplug ]; then
    echo `which mdev` > /proc/sys/kernel/hotplug
fi
mdev -d || mdev -s

/usr/bin/modprobe -a vhost_vsock vmw_vsock_virtio_transport

find /sys/ -name modalias -print0 | \
    xargs -0 sort -u | \
    tr '\n' '\0' | \
    xargs -0 /usr/bin/modprobe -abq

acpid

socat vsock-listen:4321,reuseaddr,fork "exec:'xargs --no-run-if-empty -0 sh -c',stderr" &
